<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Editor Python - Prof. Antonio Adinolfi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script>
    window.require = { paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' } };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
  <script src="./libs/pyodide.js"></script>

  <style>
    :root {
      --primary-color: #004080;
      --secondary-color: #28a745;
      --danger-color: #dc3545;
      --bg-color: #f8f9fa;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      background-color: var(--bg-color);
      /* Protezione: impedisce la selezione del testo nell'interfaccia */
      user-select: none;
      -webkit-user-select: none;
    }

    /* Layout principale: Colonna su mobile, Riga su desktop */
    #main-layout { 
        display: flex; 
        flex-direction: column; /* Gli elementi si impilano verticalmente [cite: 27] */
        height: 100vh; 
        overflow: hidden; 
    }
    
    /* Regole comuni per le due sezioni */
    #traccia, #editor-section {
        display: flex;
        flex-direction: column;
        padding: 15px;
        background: white;
        min-height: 0;
        width: 100%; /* Su mobile occupano tutta la larghezza [cite: 60] */
    }
    
    /* Su mobile, diamo un'altezza specifica per vedere entrambi */
    #traccia { height: 40vh; border-bottom: 2px solid #ddd; }
    #editor-section { height: 60vh; }
    
    /* Media Query per Desktop (schermi più larghi di 768px) */
    @media (min-width: 768px) {
        #main-layout { flex-direction: row; } /* Affiancati [cite: 36] */
        #traccia { 
            width: 45%; 
            height: 100vh; 
            border-right: 2px solid #ddd; 
            border-bottom: none;
        }
        #editor-section { 
            width: 55%; 
            height: 100vh; 
        }
    }

   #viewerContainer {
        flex-grow: 1; [cite: 48]
        border: 1px solid #ccc; [cite: 49]
        border-radius: 8px; [cite: 50]
        /* Fondamentale per lo scorrimento */
        overflow: auto !important; 
        background-color: #e0e0e0; [cite: 52]
        position: relative; [cite: 56]
        display: block; /* Cambia da flex a block per favorire lo scroll */
    }

    .traccia-img {
        transition: width 0.2s ease-in-out; [cite: 59]
        /* Rimuovi height: auto se presente e usa questa configurazione */
        max-width: none; 
        display: block; [cite: 62]
    }

    
   .controls { 
      margin-bottom: 12px; 
      display: flex; 
      gap: 8px; 
      align-items: center; 
      flex-wrap: wrap; /* Fondamentale: i bottoni scendono se non c'è posto  */
    }

    input[type="text"] { 
        flex: 1; 
        min-width: 150px; /* Impedisce che l'input diventi troppo piccolo [cite: 64] */
        padding: 8px; 
    }

    button {
      padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;
      font-weight: 600; transition: all 0.2s;
    }
    button:hover { opacity: 0.9; }

    .btn-run { background-color: var(--primary-color); color: white; }
    .btn-drive { background-color: var(--secondary-color); color: white; }
    .btn-exit { background-color: var(--danger-color); color: white; }
    .btn-zoom-ui { background-color: #f0f0f0; border: 1px solid #ccc; font-size: 18px; width: 40px; }

    /* Stili per la nuova Toolbar dello Zoom Codice */
    .zoom-toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f1f5f9;
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
    }
    .btn-z {
      background-color: var(--primary-color);
      color: white;
      padding: 4px 12px;
      font-size: 14px;
    }

    #monaco-container {
      flex-grow: 1; /* Spinge l'editor a occupare tutto lo spazio disponibile [cite: 93] */
      border: 1px solid #ccc;
      border-radius: 0 0 8px 8px;
      overflow: hidden;
      background: #1e1e1e; /* Colore scuro di sfondo per evitare il flash bianco */
    }

   #output {
      background: #1e1e1e; 
      color: #00ff00; 
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      height: 100px; /* Ridotto leggermente per mobile  */
      overflow-y: auto;
      font-size: 12px;
    }
    #timerDisplay { margin-left: auto; color: var(--danger-color); font-weight: bold; }

    @keyframes rotateHourglass {
      0% { transform: rotate(0deg); }
      45% { transform: rotate(180deg); }
      50% { transform: rotate(180deg); }
      95% { transform: rotate(360deg); }
      100% { transform: rotate(360deg); }
    }

    .clessidra-icon {
        display: inline-block;
        font-size: 18px;
        animation: rotateHourglass 3s infinite ease-in-out;
    }
  </style>
</head>

<body oncontextmenu="return false;" oncopy="return false;" oncut="return false;" onpaste="return false;">

<div id="main-layout">
  <div id="traccia">
    <div class="controls">
      <select id="tracciaSelect" onchange="updateTraccia(this.value)"></select>
      <div id="imgZoomControls" style="display:none;">
        <button class="btn-zoom-ui" onclick="zoomImage(1.2)">+</button>
        <button class="btn-zoom-ui" onclick="zoomImage(0.8)">-</button>
      </div>
    </div>
    <div id="viewerContainer">
      <iframe id="pdfFrame" src="" style="width:100%; height:100%; border:none;"></iframe>
    </div>
  </div>

  <div id="editor-section">
    <div class="controls">
      <input type="text" id="nomeStudente" placeholder="Nome e Cognome Studente">
      <div style="display: inline-flex; flex-direction: column; align-items: flex-end; margin-left: auto; margin-right: 15px;">
        <div style="font-size: 11px; color: #666;">Inattività:<span class="clessidra-icon">⌛</span>
          <span id="timerDisplay" style="display: none;">--:--</span> 
        </div>
        <div style="font-weight: bold; color: var(--primary-color);">Fine Prova: <span id="maxTimerDisplay">--:--</span></div>
      </div>
      <button class="btn-exit" onclick="tornaAllaPaginaPrincipale()">Esci</button>
    </div>

    <div class="zoom-toolbar">
        <span style="font-size: 12px; font-weight: bold; color: var(--primary-color);">ZOOM CODICE:</span>
        <button class="btn-z" onclick="changeEditorZoom(2)">+</button>
        <button class="btn-z" onclick="changeEditorZoom(-2)">-</button>
        <button class="btn-z" onclick="resetEditorZoom()" style="background:#64748b;">Reset</button>
        <button class="btn-z" id="focusBtn" onclick="toggleFocusMode()" style="background: #8b5cf6; margin-left: 5px;">Solo Editor</button>
    </div>
    <div id="monaco-container"></div>

    <div class="controls" style="margin-top: 10px;">
      <button class="btn-run" id="eseguiBtn" onclick="runCode()">⌛ Caricamento Python...</button>
      <button class="btn-drive" onclick="inviaConsegnaDrive()">☁️ Invia al Drive</button>
    </div>
    <pre id="output">Inizializzazione ambiente Python...</pre>
  </div>
</div>

<iframe name="gasTarget" id="gasTarget" style="display:none;"></iframe>
<script>
/* ============================================================
   VARIABILI GLOBALI
============================================================ */
let editor = null;
let pyodide = null;

let timeLeft = 300;          // Timer inattività
let maxTimeLeft = 2700;      // Timer prova (45 min)
let startTime = new Date();

let mainTimerId = null;
let backupSaveId = null;

let currentFontSize = 14;
let currentImgWidth = 100;

/* ============================================================
   UTILITY: NOTIFICA NON BLOCCANTE
============================================================ */
function showNotice(msg) {
  const t = document.createElement("div");
  t.textContent = msg;
  Object.assign(t.style, {
    position: "fixed",
    right: "16px",
    bottom: "16px",
    background: "#111",
    color: "#fff",
    padding: "8px 12px",
    borderRadius: "6px",
    zIndex: 99999,
    opacity: 0.95,
    fontSize: "13px"
  });
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 2000);
}

/* ============================================================
   BLOCCO INCOLLA (robusto)
============================================================ */
function attachPasteBlockers() {

  const blockPasteHandler = (e) => {
    e.preventDefault();
    e.stopPropagation();
    showNotice("Incollare è disabilitato.");
    return false;
  };

  // Blocca incolla globale
  document.addEventListener("paste", blockPasteHandler, true);

  // Blocca CTRL/CMD + V
  document.addEventListener("keydown", (e) => {
    const key = (e.key || "").toLowerCase();
    if ((e.ctrlKey || e.metaKey) && key === "v") {
      e.preventDefault();
      e.stopPropagation();
      showNotice("Incollare è disabilitato.");
    }
  }, true);

  // Blocca middle-click paste
  document.addEventListener("mouseup", (e) => {
    if (e.button === 1) {
      e.preventDefault();
      e.stopPropagation();
    }
  }, true);

  // Blocca incolla dentro Monaco
  if (editor && editor.getDomNode) {
    const dom = editor.getDomNode();
    dom.addEventListener("paste", blockPasteHandler, true);

    try {
      editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KEY_V, () => {
        showNotice("Incollare è disabilitato.");
      });
    } catch (err) {
      console.warn("Comando Monaco non registrato", err);
    }
  }
}

/* ============================================================
   MONACO EDITOR
============================================================ */
function initMonacoEditor(initialCode = "# Scrivi qui il tuo codice Python\n") {
  return new Promise((resolve, reject) => {
    try {
      require(["vs/editor/editor.main"], function () {
        try {
          editor = monaco.editor.create(document.getElementById("monaco-container"), {
            value: initialCode,
            language: "python",
            theme: "vs-dark",
            automaticLayout: true,
            fontSize: currentFontSize,
            contextmenu: false,
            minimap: { enabled: false }
          });

          editor.onDidChangeModelContent(() => resetActivityTimer());
          resolve(editor);

        } catch (err) { reject(err); }
      });
    } catch (e) { reject(e); }
  });
}

/* ============================================================
   PYODIDE
============================================================ */
async function runCode() {
  const out = document.getElementById("output");
  out.textContent = "Esecuzione...\n";

  try {
    if (!pyodide) {
      pyodide = await loadPyodide({
        indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"
      });
    }

    const code = editor.getValue();

    await pyodide.runPythonAsync(`
import sys, io
sys.stdout = io.StringIO()
`);

    await pyodide.runPythonAsync(code);

    const result = pyodide.runPython("sys.stdout.getvalue()");
    out.textContent = result || "Eseguito.";

  } catch (e) {
    out.textContent = "Errore:\n" + e;
  }
}

/* ============================================================
   TIMER
============================================================ */
function aggiornaDisplayTimer() {
  const maxTimerDisplay = document.getElementById("maxTimerDisplay");
  const m = Math.floor(maxTimeLeft / 60);
  const s = maxTimeLeft % 60;
  maxTimerDisplay.textContent = `${m}:${s.toString().padStart(2, "0")}`;
}

function resetActivityTimer() {
  timeLeft = 300;
}

function onTimeExpired(classKey) {
  clearInterval(mainTimerId);
  clearInterval(backupSaveId);

  timeLeft = 0;
  maxTimeLeft = 0;
  aggiornaDisplayTimer();

  if (editor) editor.updateOptions({ readOnly: true });

  const btn = document.getElementById("eseguiBtn");
  btn.disabled = true;
  btn.textContent = "Tempo scaduto";

  localStorage.removeItem(`timer_${classKey}`);

  alert("Tempo scaduto!");
}

function startTimers(classKey) {
  clearInterval(mainTimerId);
  clearInterval(backupSaveId);

  const saved = localStorage.getItem(`timer_${classKey}`);
  if (saved) maxTimeLeft = parseInt(saved);

  aggiornaDisplayTimer();

  mainTimerId = setInterval(() => {
    if (timeLeft <= 0 || maxTimeLeft <= 0) {
      onTimeExpired(classKey);
      return;
    }
    timeLeft--;
    maxTimeLeft--;
    localStorage.setItem(`timer_${classKey}`, maxTimeLeft);
    aggiornaDisplayTimer();
  }, 1000);

  backupSaveId = setInterval(() => {
    if (editor) {
      localStorage.setItem(`codiceSalvato_${classKey}`, editor.getValue());
    }
  }, 120000);
}

/* ============================================================
   TRACCIA PDF / IMMAGINE
============================================================ */
function updateTraccia(filePath) {
  const container = document.getElementById("viewerContainer");
  const zoomControls = document.getElementById("imgZoomControls");

  const isImage = /\.(jpg|jpeg|png|gif)$/i.test(filePath);

  if (isImage) {
    container.innerHTML = `
      <img src="${filePath}" class="traccia-img" 
           style="width:100%; height:auto; display:block;">
    `;
    zoomControls.style.display = "block";
    currentImgWidth = 100;

  } else {
    container.innerHTML = `
      <iframe src="${filePath}" 
              style="width:100%; height:100%; border:none;"></iframe>
    `;
    zoomControls.style.display = "none";
  }

  resetActivityTimer();
}


function zoomImage(step) {
  const img = document.querySelector(".traccia-img");
  if (!img) return;

  currentImgWidth *= step;
  if (currentImgWidth < 10) currentImgWidth = 10;

  img.style.width = currentImgWidth + "%";
}

/* ============================================================
   INVIO RTF (versione professionale)
============================================================ */
window.inviaConsegnaDrive = function () {

  const nome = document.getElementById("nomeStudente").value.trim();
  if (!nome) return alert("Inserisci Nome e Cognome!");

  const endTime = new Date();
  const diffMs = endTime - startTime;
  const diffMins = Math.floor(diffMs / 60000);
  const diffSecs = Math.floor((diffMs % 60000) / 1000);
  const tempoTotale = `${diffMins} minuti e ${diffSecs} secondi`;

  const codice = editor.getValue();
  const outputText = document.getElementById("output").textContent;

  const urlParams = new URLSearchParams(window.location.search);
  const classe = urlParams.get("classe") || "ND";

  const rtfContent = `{\\rtf1\\ansi
{\\colortbl;
 \\red0\\green0\\blue0;
 \\red0\\green0\\blue255;
 \\red200\\green0\\blue0;
 \\red0\\green128\\blue0;
}

\\fs28 \\b Dati Studente \\b0 \\fs20 \\par
\\cf1 Nome: \\cf0 ${nome}\\par
\\cf1 Classe: \\cf0 ${classe}\\par
\\cf1 Inizio Prova: \\cf0 ${startTime.toLocaleString()}\\par
\\cf1 Fine Prova: \\cf0 ${endTime.toLocaleString()}\\par
\\cf1 Tempo Totale: \\cf0 ${tempoTotale}\\par
\\par
\\pard\\qr ------------------------------ \\pard\\ql \\par

\\fs28 \\b Codice Python \\b0 \\fs20 \\par
{\\f1\\fs18
${codice
  .replace(/\\/g, "\\\\")
  .replace(/\{/g, "\\{")
  .replace(/\}/g, "\\}")
  .replace(/\n/g, "\\par \\tab ")
}
}\\par
\\pard\\qr ------------------------------ \\pard\\ql \\par

\\fs28 \\b Output \\b0 \\fs20 \\par
{\\cf3\\f1\\fs18
${outputText
  .replace(/\\/g, "\\\\")
  .replace(/\{/g, "\\{")
  .replace(/\}/g, "\\}")
  .replace(/\n/g, "\\par \\tab ")
}
}\\par
}`;

  // Download locale
  const blob = new Blob([rtfContent], { type: "application/rtf" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `Consegna_${nome.replace(/\s+/g, "_")}.rtf`;
  a.click();

  // Invio a Google Apps Script
  try {
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyXYR1fJ2yYKKbgd_cIdNUTbIG5fZH3piPQ75Bw2TC-YkMcUaM7bOvzUQWNNGGmjcdg/exec";

    const form = document.createElement("form");
    form.method = "POST";
    form.action = GAS_URL;
    form.target = "gasTarget";

    const add = (n, v) => {
      const i = document.createElement("input");
      i.type = "hidden";
      i.name = n;
      i.value = v;
      form.appendChild(i);
    };

    add("nomeStudente", nome);
    add("classe", classe);
    add("dataOra", endTime.toLocaleString());
    add("rtfContent", rtfContent);
    add("pyContent", codice);

    document.body.appendChild(form);
    form.submit();
    form.remove();

    alert("Consegna inviata al Drive!");

  } catch (e) {
    console.warn("Invio Drive fallito", e);
  }
};

/* ============================================================
   AVVIO COMPLETO
============================================================ */
document.addEventListener("DOMContentLoaded", async () => {
  await initMonacoEditor();
  attachPasteBlockers();
});
</script>

</body>
</html>
