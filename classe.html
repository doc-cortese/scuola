<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Lancio Esercizio Python e Consegna</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow-y: hidden; 
      background-color: #f0f0f0;
    }
    #traccia, #editor {
      padding: 15px;
      box-sizing: border-box;
      overflow-y: auto;
      background-color: white; 
    }
    #traccia {
      border-right: 1px solid #ddd;
    }
    #pdfFrame {
      width: 100%;
      height: 300px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    input[type="text"], textarea {
      width: 100%;
      margin-top: 10px;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box; /* Importante per width: 100% */
    }
    input[type="file"] {
        margin-top: 10px;
    }
    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px; /* Spazio maggiore per i pulsanti di consegna */
    }
    .button-row button {
      flex: 1 1 auto; 
      padding: 12px 10px;
      font-size: 15px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    
    /* Stili per i pulsanti specifici */
    #githubBtn {
        background-color: #004080;
        color: white;
        font-weight: bold;
    }
    #rtfBtn {
        background-color: #f7a81b; /* Giallo per l'esportazione */
        color: #004080;
        font-weight: bold;
    }
    
    .button-row button:hover:not(:disabled) {
        opacity: 0.9;
    }
    .button-row button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    h2 {
        color: #004080;
    }
    
    /* Stile per il riquadro di istruzioni */
    .istruzioni-box {
        background-color: #e6f0ff; 
        padding: 15px; 
        border-left: 5px solid #004080; 
        margin-bottom: 15px;
        border-radius: 4px;
    }
    .istruzioni-box button {
        background-color: #004080 !important; /* Forza lo stile per il pulsante Launch */
        color: white !important;
        font-weight: bold !important;
        padding: 10px 15px !important;
        margin-top: 10px;
    }

    @media (min-width: 768px) {
      body {
        flex-direction: row;
      }
      #traccia, #editor {
        width: 50%;
        height: 100vh;
      }
      #pdfFrame {
        height: calc(100vh - 150px);
      }
    }
  </style>
</head>

<body>
  <div id="traccia">
    <h2>Traccia <span id="classeTitolo"></span></h2>
    <select onchange="cambiaTraccia(this)" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
      <option value="tracce/default.pdf">Cambia Esercizio...</option>
      <option value="tracce/Esercizio_03122025.pdf">Esercizio 03/12/2025</option>
      <option value="tracce/Esercizio_04122025.pdf">Esercizio 04/12/2025</option>
    </select>

    <iframe id="pdfFrame" src=""></iframe>
  </div>

  
  <div id="editor">
    <h2>Spazio di Lavoro e Consegna</h2>
    
    <div class="istruzioni-box">
        <p style="font-weight: bold; margin-top: 0;">1. Svolgi l'esercizio sul Notebook</p>
        <p style="margin-bottom: 5px;">Clicca qui sotto per aprire l'ambiente **JupyterLite** e scrivere il tuo codice.</p>
        
        <button onclick="lanciaJupyterLite()">APRI NOTEBOOK JUPYTERLITE</button>
    </div>

    <input type="text" id="nomeStudente" placeholder="Il tuo nome e cognome (necessario per la consegna)" />
    <input type="file" accept=".py" onchange="caricaFile(this)" title="Carica un file Python (py) locale" disabled style="background-color: #eee;" />
    
    <p style="font-weight: bold; margin-top: 25px; margin-bottom: 5px;">2. Incolla il codice e l'output dal Notebook</p>
    
    <textarea id="codicePaste" rows="10" placeholder="<<< INCOLLA QUI IL TUO CODICE PYTHON DAL NOTEBOOK >>>"></textarea>
    <textarea id="outputPaste" rows="5" placeholder="<<< INCOLLA QUI L'OUTPUT DEL CODICE >>>"></textarea>

    <div class="button-row">
      <button id="githubBtn" onclick="inviaCodice('github')">Invia Codice (GitHub Issue)</button>
      <button id="rtfBtn" onclick="esportaRTF()">Esporta Consegna (RTF)</button>
    </div>
    
  </div>

  <script>
    // URL di base per la tua installazione di JupyterLite (DA AGGIORNARE)
    const JUPYTERLITE_BASE_URL = "https://tuo-dominio.com/jupyterlite/index.html"; 

    /**
     * Lancia l'ambiente JupyterLite.
     */
    window.lanciaJupyterLite = function() {
        // Logica per determinare quale Notebook aprire in base alla classe
        const urlParams = new URLSearchParams(window.location.search);
        const classe = urlParams.get("classe") || "Default";
        
        // Esempio: Apre il Notebook "Esercizio_Prime.ipynb"
        const notebookPath = `Esercizi/Esercizio_${classe}.ipynb`; 
        
        // Costruisci il link per aprire il Notebook direttamente in una nuova scheda
        const url = `${JUPYTERLITE_BASE_URL}?path=${encodeURIComponent(notebookPath)}`;
        
        window.open(url, "_blank");
    }

    
    /**
     * ðŸ”¥ NUOVA FUNZIONE: Esporta i dati come file RTF.
     */
    window.esportaRTF = function () {
        const nome = document.getElementById("nomeStudente").value.trim();
        const codice = document.getElementById("codicePaste").value;
        const output = document.getElementById("outputPaste").value;
        
        const urlParams = new URLSearchParams(window.location.search);
        const classe = urlParams.get("classe") || "N/D";
        
        const tracciaUrl = document.getElementById("pdfFrame").src;
        const tracciaNome = tracciaUrl.split("/").pop().split("?")[0] || "Default"; 
        const dataOra = new Date().toLocaleString("it-IT");

        if (!nome || codice.trim() === "" || output.trim() === "") {
            return alert("Inserisci il tuo nome e incolla il codice e l'output per esportare il file RTF.");
        }
        
        // Costruzione del contenuto in formato RTF (Rich Text Format)
        const rtfContent = `{\\rtf1\\ansi\\deff0
{\\fonttbl{\\f0 Arial;}{\\f1 Courier New;}}
\\pard\\sa200\\sl276\\slmult1\\f0\\fs24 
\\b CONSEGNA ESERCIZIO SVOLTO\\b0\\par
\\b =====================================\\b0\\par
Studente: ${nome}\\par
Classe: ${classe}\\par
Data e Ora: ${dataOra}\\par
Traccia di Riferimento: ${tracciaNome}\\par
\\b =====================================\\b0\\par
\\par
\\b CODICE PYTHON\\b0\\par
\\b -------------------------------------\\b0\\par
\\f1\\fs20 ${codice.replace(/\\/g, '\\\\').replace(/{/g, '\\{').replace(/}/g, '\\}').replace(/\n/g, '\\par\n')}\\f0\\fs24\\par
\\b -------------------------------------\\b0\\par
\\par
\\b OUTPUT DEL CODICE\\b0\\par
\\b -------------------------------------\\b0\\par
\\f1\\fs20 ${output.replace(/\\/g, '\\\\').replace(/{/g, '\\{').replace(/}/g, '\\}').replace(/\n/g, '\\par\n')}\\f0\\fs24\\par
\\b -------------------------------------\\b0\\par
}`;
        
        const mimeType = 'application/rtf;charset=utf-8;';
        const blob = new Blob([rtfContent], { type: mimeType });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        const fileName = `consegna_RTF_${nome.replace(/ /g, '_')}_${classe}.rtf`;
        link.setAttribute('download', fileName);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert(`File RTF salvato con successo come "${fileName}" nella cartella Download!`);
    };


    /**
     * Invia l'esercizio a GitHub (Issue).
     */
    window.inviaCodice = function (destinazione) {
        // Legge i dati incollati
        const nome = document.getElementById("nomeStudente").value.trim();
        const codice = document.getElementById("codicePaste").value;
        const output = document.getElementById("outputPaste").value;
        
        const urlParams = new URLSearchParams(window.location.search);
        const classe = urlParams.get("classe") || "Non Specificata";
        
        const tracciaUrl = document.getElementById("pdfFrame").src;
        const tracciaNome = tracciaUrl.split("/").pop().split("?")[0] || "Default"; 
        const dataOra = new Date().toLocaleString("it-IT");

        if (!nome || codice.trim() === "" || output.trim() === "") {
            return alert("Inserisci il tuo nome e incolla il codice e l'output per inviare l'esercizio su GitHub.");
        }

        const corpoPost = `
**Consegna Esercizio Python**

Studente: ${nome}
Classe: ${classe}
Data e ora: ${dataOra}
Traccia: ${tracciaNome}

--------------------------------------
### Codice (Copiato da Notebook):
\`\`\`python
${codice}
\`\`\`

### Output (Copiato da Notebook):
\`\`\`
${output}
\`\`\`
`;
        
        if (destinazione === 'github') {
             // *********** AGGIORNA QUESTO PERCORSO CON IL TUO REPO ***********
            const repo = "doc-cortese/esercizi2025"; 
            // *************************************************
            const titolo = `Esercizio di ${nome} â€“ ${dataOra} (Classe ${classe})`;
            
            // Crea un link diretto per l'apertura di una Nuova Issue
            const url = `https://github.com/${repo}/issues/new?title=${encodeURIComponent(titolo)}&body=${encodeURIComponent(corpoPost)}`;
            
            window.open(url, "_blank");
            alert("Consegna preparata per GitHub. Clicca su 'Submit new issue' nella nuova finestra per completare l'invio al repository!");

        } 
    };


    /**
     * Funzione non piÃ¹ rilevante con JupyterLite, ma mantenuta come placeholder.
     */
    window.caricaFile = function (input) {
        alert("Carica file non supportato in questa modalitÃ . Usa il Notebook per caricare i dati.");
    };

    /**
     * Cambia la traccia PDF visualizzata.
     */
    window.cambiaTraccia = function (select) {
      const url = select.value + "?t=" + new Date().getTime(); 
      document.getElementById("pdfFrame").src = url;
    };
    
    // ------------------------------------
    // 4. GESTIONE URL E CLASSE
    // ------------------------------------

    document.addEventListener("DOMContentLoaded", () => {
      const urlParams = new URLSearchParams(window.location.search);
      const classe = urlParams.get("classe");
      const pdfFrame = document.getElementById("pdfFrame");
      const classeTitolo = document.getElementById("classeTitolo");
      
      let pdfPath = "tracce/default.pdf"; 
      
      if (classe) {
          pdfPath = `tracce/Esercizio_${classe}.pdf`; 
          classeTitolo.textContent = `â€“ Classe ${classe}`;
      }
      
      pdfFrame.src = pdfPath;
      
      // Carica e salva il nome dello studente
      const nomeStudenteInput = document.getElementById("nomeStudente");
      const nomeSalvato = localStorage.getItem("nomeStudente");
      if (nomeSalvato) {
          nomeStudenteInput.value = nomeSalvato;
      }
      nomeStudenteInput.addEventListener('input', (e) => {
        localStorage.setItem("nomeStudente", e.target.value);
      });
    });
  </script>
</body>
</html>
