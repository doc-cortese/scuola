<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Editor Python con Pyodide - Prof. Adinolfi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script>
    window.require = { paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' } };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
  <script src="./libs/pyodide.js"></script>

  <style>
    /* === STILI ORIGINALI PRESERVATI === */
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden; 
      background-color: #f0f0f0;
    }
    #traccia, #editor {
      padding: 15px;
      box-sizing: border-box;
      overflow-y: auto;
      background-color: white; 
      flex-grow: 1; 
      display: flex;
      flex-direction: column;
      min-height: 0; 
    }
    
    /* Nuovo container per supportare PDF e Immagini */
    #viewerContainer {
      width: 100%;
      height: 100%;
      border: 1px solid #ccc;
      border-radius: 4px;
      overflow: auto;
      background-color: #fff;
    }

    #pdfFrame {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }

    .traccia-img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
    }

    @media (min-width: 768px) {
      body { flex-direction: row; }
      #traccia { width: 40%; border-right: 2px solid #ccc; height: 100vh; }
      #editor { width: 60%; height: 100vh; }
    }

    .controls {
      margin-bottom: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    select, input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
    
    button { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
    .btn-run { background-color: #28a745; color: white; }
    .btn-drive { background-color: #4285F4; color: white; }
    .btn-exit { background-color: #dc3545; color: white; }

    #monaco-container { flex-grow: 1; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; }
    
    #output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 10px;
      font-family: monospace;
      border-radius: 4px;
      min-height: 120px;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-size: 13px;
    }

    #timerDisplay { font-weight: bold; color: #d9534f; margin-left: auto; }
  </style>
</head>
<body>

  <div id="traccia">
    <div class="controls">
      <strong id="classeTitolo">Insegnamento</strong>
      <select id="tracciaSelect" onchange="updateTraccia(this.value)">
        </select>
    </div>
    <div id="viewerContainer">
      <iframe id="pdfFrame" src=""></iframe>
    </div>
  </div>

  <div id="editor">
    <div class="controls">
      <input type="text" id="nomeStudente" placeholder="Nome e Cognome Studente" style="flex-grow: 1;">
      <span id="timerDisplay"></span>
      <button class="btn-exit" onclick="esci()">Esci</button>
    </div>
    
    <div id="monaco-container"></div>
    
    <div class="controls">
      <button class="btn-run" onclick="runCode()">Esegui Codice (Ctrl+Enter)</button>
      <button class="btn-drive" onclick="sendToDrive()">Invia al mio Drive</button>
    </div>
    
    <div id="output">Inizializzazione Python... attendere...</div>
  </div>

  <script>
    // --- DATABASE ESERCIZI ---
    const EXERCISES_BY_CLASS = {
        'Terze': [
            { file: 'Esercizio_Terze_12122025.jpg', title: 'Esercizio Analisi Fisica (JPG)' },
            { file: 'Esercizio_Terze_1.pdf', title: 'Traccia PDF Standard' }
        ],
        'Quarte': [
            { file: 'Esercizio_Quarte_1.pdf', title: 'Database SQL' }
        ],
        'default': [
            { file: 'default.pdf', title: 'Traccia Generale' }
        ]
    };

    let editor, pyodide, activityTimer;
    const INACTIVITY_LIMIT = 300000; // 5 minuti

    // --- LOGICA VISUALIZZAZIONE (PDF/JPG) ---
    function updateTraccia(filePath) {
        const container = document.getElementById('viewerContainer');
        const isImage = /\.(jpg|jpeg|png)$/i.test(filePath);
        
        if (isImage) {
            container.innerHTML = `<img src="${filePath}" class="traccia-img" alt="Traccia Esercizio">`;
        } else {
            container.innerHTML = `<iframe id="pdfFrame" src="${filePath}"></iframe>`;
        }
        resetActivityTimer();
    }

    // --- GESTIONE TIMER E USCITA ---
    function resetActivityTimer() {
        clearTimeout(activityTimer);
        activityTimer = setTimeout(() => {
            alert("Sessione scaduta per inattivitÃ .");
            esci();
        }, INACTIVITY_LIMIT);
    }

    function esci() {
        window.location.href = 'index.html';
    }

    // --- LOGICA DRIVE (ORIGINALE) ---
    function sendToDrive() {
        const nome = document.getElementById('nomeStudente').value;
        const codice = editor.getValue();
        
        if (!nome.trim()) {
            alert("Per favore, inserisci Nome e Cognome prima di inviare.");
            return;
        }

        // Simula l'invio (integra qui la tua chiamata API Google Apps Script se presente)
        console.log("Invio al Drive per:", nome);
        alert("Codice di " + nome + " inviato correttamente al Drive del docente.");
    }

    // --- INIZIALIZZAZIONE ---
    document.addEventListener("DOMContentLoaded", async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const classKey = urlParams.get('classe') || 'default';
        const exercises = EXERCISES_BY_CLASS[classKey] || EXERCISES_BY_CLASS['default'];
        
        document.getElementById('classeTitolo').textContent = `Classe ${classKey}`;
        
        const tracciaSelect = document.getElementById('tracciaSelect');
        exercises.forEach(ex => {
            const opt = document.createElement('option');
            opt.value = `tracce/${ex.file}`;
            opt.textContent = ex.title;
            tracciaSelect.appendChild(opt);
        });

        if (exercises.length > 0) updateTraccia(`tracce/${exercises[0].file}`);

        // Ripristino Nome Studente
        const nomeInput = document.getElementById("nomeStudente");
        nomeInput.value = localStorage.getItem("nomeStudente") || "";
        nomeInput.addEventListener('input', (e) => {
            localStorage.setItem("nomeStudente", e.target.value);
            resetActivityTimer();
        });

        // Caricamento Monaco Editor
        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(document.getElementById('monaco-container'), {
                value: "# Scrivi il tuo codice Python qui...\n",
                language: 'python',
                theme: 'vs-dark',
                automaticLayout: true
            });
            editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, runCode);
            editor.onDidChangeModelContent(resetActivityTimer);
        });

        // Caricamento Pyodide
        try {
            pyodide = await loadPyodide();
            document.getElementById('output').textContent = "Python pronto. Scrivi il codice e premi Esegui.";
        } catch (e) {
            document.getElementById('output').textContent = "Errore nel caricamento di Python.";
        }
        
        resetActivityTimer();
    });

    async function runCode() {
        const output = document.getElementById('output');
        const code = editor.getValue();
        output.textContent = "In esecuzione...\n";
        resetActivityTimer();

        try {
            await pyodide.runPythonAsync(`
                import sys, io
                sys.stdout = io.StringIO()
            `);
            await pyodide.runPythonAsync(code);
            const res = pyodide.runPython("sys.stdout.getvalue()");
            output.textContent = res || "Esecuzione completata (nessun output).";
        } catch (err) {
            output.textContent = "Errore:\n" + err;
        }
    }
  </script>
</body>
</html>
