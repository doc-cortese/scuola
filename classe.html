<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Editor Python - Prof. Antonio Adinolfi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script>
    window.require = { paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' } };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
  <script src="./libs/pyodide.js"></script>

  <style>
    :root {
      --primary-color: #004080;
      --secondary-color: #28a745;
      --danger-color: #dc3545;
      --bg-color: #f8f9fa;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      background-color: var(--bg-color);
    }

    #main-layout { display: flex; flex-direction: column; height: 100vh; }
    @media (min-width: 768px) {
      #main-layout { flex-direction: row; }
      #traccia { width: 45%; border-right: 2px solid #ddd; }
      #editor-section { width: 55%; }
    }

    #traccia, #editor-section {
      padding: 15px;
      display: flex;
      flex-direction: column;
      min-height: 0;
      background: white;
    }

    #viewerContainer {
      flex-grow: 1;
      border: 1px solid #ccc;
      border-radius: 8px;
      overflow: auto;
      background-color: #ffffff;
      display: flex;
      justify-content: center;
    }

    #pdfFrame { width: 100%; height: 100%; border: none; }
    .traccia-img { max-width: 100%; height: auto; object-fit: contain; padding: 10px; }

    .controls { margin-bottom: 12px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .label-bold { font-weight: bold; color: var(--primary-color); }

    input, select { padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }

    button {
      padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;
      font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;
    }

    button:hover { opacity: 0.9; transform: translateY(-1px); }

    .btn-run { background-color: var(--primary-color); color: white; }
    .btn-drive { background-color: var(--secondary-color); color: white; }
    .btn-exit { background-color: var(--danger-color); color: white; }
    .btn-zoom { background-color: #e9ecef; border: 1px solid #adb5bd; color: #495057; }

    #monaco-container { flex-grow: 1; border: 1px solid #ccc; border-radius: 8px; overflow: hidden; }

    #output {
      background: #1e1e1e; color: #00ff00; padding: 12px; font-family: 'Consolas', monospace;
      border-radius: 8px; margin-top: 10px; height: 150px; overflow-y: auto; white-space: pre-wrap;
    }

    #timerDisplay { margin-left: auto; color: var(--danger-color); font-weight: bold; padding: 5px 12px; border: 1px solid #ffcccc; border-radius: 20px; }
  </style>
</head>
<body>

<div id="main-layout">
  <div id="traccia">
    <div class="controls">
      <span class="label-bold" id="classeTitolo">Classe</span>
      <select id="tracciaSelect" onchange="updateTraccia(this.value)"></select>
    </div>
    <div id="viewerContainer">
      <iframe id="pdfFrame" src=""></iframe>
    </div>
  </div>

  <div id="editor-section">
    <div class="controls">
      <input type="text" id="nomeStudente" placeholder="Nome e Cognome Studente" style="flex-grow: 1;">
      <button class="btn-zoom" title="Zoom In" onclick="changeZoom(1.2)">A+</button>
      <button class="btn-zoom" title="Zoom Out" onclick="changeZoom(0.8)">A-</button>
      <span id="timerDisplay">05:00</span>
      <button class="btn-exit" onclick="tornaAllaPaginaPrincipale()">Esci</button>
    </div>

    <div id="monaco-container"></div>

    <div class="controls" style="margin-top: 12px;">
      <button class="btn-run" id="eseguiBtn" onclick="runCode()" disabled>‚åõ Caricamento...</button>
      <button class="btn-drive" onclick="inviaConsegnaDrive()">‚òÅÔ∏è Invia al Drive</button>
    </div>
    <pre id="output">Inizializzazione Python...</pre>
  </div>
</div>

<iframe name="gasTarget" id="gasTarget" style="display:none;"></iframe>

<script>
  const EXERCISES_BY_CLASS = {
    'Terze': [
      { file: 'Esercizio_Terze_12122025.jpg', title: 'Analisi Fisica (JPG)' },
      { file: 'Esercizio_Terze_1.pdf', title: 'Analisi Fisica (PDF)' }
    ],
    'Quarte': [{ file: 'Esercizio_Quarte_1.pdf', title: 'Algoritmi e Database' }],
    'default': [{ file: 'default.pdf', title: 'Traccia' }]
  };

  let editor, pyodide, timeLeft = 300, currentFontSize = 14;

  function updateTraccia(filePath) {
    const container = document.getElementById('viewerContainer');
    if (/\.(jpg|jpeg|png|gif)$/i.test(filePath)) {
      container.innerHTML = `<img src="${filePath}" class="traccia-img">`;
    } else {
      container.innerHTML = `<iframe id="pdfFrame" src="${filePath}" style="width:100%; height:100%; border:none;"></iframe>`;
    }
    resetActivityTimer();
  }

  function changeZoom(multiplier) {
    currentFontSize = Math.round(currentFontSize * multiplier);
    currentFontSize = Math.max(8, Math.min(40, currentFontSize));
    editor.updateOptions({ fontSize: currentFontSize });
  }

  // --- LOGICA DI INVIO RIPRISTINATA DAL FILE 10 CON IL TUO URL ---
  window.inviaConsegnaDrive = function() {
    const nome = document.getElementById("nomeStudente").value.trim();
    if (!nome) return alert("Inserisci Nome e Cognome!");

    const codice = editor.getValue();
    const outputText = document.getElementById("output").textContent;
    const urlParams = new URLSearchParams(window.location.search);
    const classe = urlParams.get("classe") || "ND";
    const dataOra = new Date().toLocaleString("it-IT");

    // Generazione contenuto RTF per il Drive
    const rtfContent = `{\\rtf1\\ansi Studente: ${nome}\\par Classe: ${classe}\\par Data: ${dataOra}\\par\\par CODICE:\\par ${codice.replace(/\n/g, '\\par ')}\\par\\par OUTPUT:\\par ${outputText.replace(/\n/g, '\\par ')} }`;

    // Download locale di backup (come nel tuo file originale)
    const blob = new Blob([rtfContent], { type: 'application/rtf' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `Consegna_${nome.replace(/\s+/g, '_')}.rtf`;
    a.click();

    // Invio al tuo Apps Script (URL riga 168 del tuo file 11)
    const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyXYR1fJ2yYKKbgd_cIdNUTbIG5fZH3piPQ75Bw2TC-YkMcUaM7bOvzUQWNNGGmjcdg/exec";
    
    const form = document.createElement('form');
    form.method = 'POST'; form.action = GAS_WEB_APP_URL; form.target = 'gasTarget';
    
    const addField = (n, v) => {
      const i = document.createElement('input'); i.type = 'hidden'; i.name = n; i.value = v;
      form.appendChild(i);
    };
    addField('nomeStudente', nome);
    addField('classe', classe);
    addField('dataOra', dataOra);
    addField('rtfContent', rtfContent);
    addField('pyContent', codice);
    
    document.body.appendChild(form);
    form.submit();
    alert("‚úÖ Consegna inviata al Drive del Prof. Adinolfi e backup scaricato!");
  };

  function resetActivityTimer() { timeLeft = 300; }
  function tornaAllaPaginaPrincipale() { window.location.href = '../index.html'; }

  require(['vs/editor/editor.main'], function () {
    editor = monaco.editor.create(document.getElementById('monaco-container'), {
      value: localStorage.getItem("autoSaveCode") || "# Scrivi qui il tuo codice\n",
      language: 'python',
      theme: 'vs-dark',
      fontSize: currentFontSize,
      automaticLayout: true,
      mouseWheelZoom: true
    });

    // Blocco Incolla
    editor.onDidPaste((e) => { e.stopImmediatePropagation(); alert('üö´ Incolla disabilitato.'); });

    editor.onDidChangeModelContent(() => {
      localStorage.setItem("autoSaveCode", editor.getValue());
      resetActivityTimer();
    });
  });

  async function runCode() {
    const out = document.getElementById('output');
    out.textContent = "Esecuzione...";
    try {
      if (!pyodide) pyodide = await loadPyodide();
      document.getElementById('eseguiBtn').disabled = false;
      document.getElementById('eseguiBtn').textContent = "‚ñ∂ Esegui Codice";
      
      await pyodide.runPythonAsync(`import sys, io\nsys.stdout = io.StringIO()`);
      await pyodide.runPythonAsync(editor.getValue());
      out.textContent = pyodide.runPython("sys.stdout.getvalue()") || "Eseguito.";
    } catch (e) { out.textContent = "Errore:\n" + e; }
  }

  document.addEventListener("DOMContentLoaded", async () => {
    runCode(); // Inizializza pyodide
    const urlParams = new URLSearchParams(window.location.search);
    const classeRaw = urlParams.get('classe') || 'default';
    const classKey = classeRaw.charAt(0).toUpperCase() + classeRaw.slice(1);
    const exercises = EXERCISES_BY_CLASS[classKey] || EXERCISES_BY_CLASS['default'];
    
    document.getElementById('classeTitolo').textContent = `‚Äì Classe ${classKey}`;
    const select = document.getElementById('tracciaSelect');
    exercises.forEach(ex => {
      const opt = document.createElement('option');
      opt.value = `tracce/${ex.file}`;
      opt.textContent = ex.title;
      select.appendChild(opt);
    });

    if (exercises.length > 0) updateTraccia(`tracce/${exercises[0].file}`);

    const ns = document.getElementById('nomeStudente');
    ns.value = localStorage.getItem("nomeStudente") || "";
    ns.oninput = () => localStorage.setItem("nomeStudente", ns.value);

    setInterval(() => {
      if (timeLeft <= 0) tornaAllaPaginaPrincipale();
      timeLeft--;
      const m = Math.floor(timeLeft / 60);
      const s = timeLeft % 60;
      document.getElementById('timerDisplay').textContent = `${m}:${s.toString().padStart(2, '0')}`;
    }, 1000);
  });
</script>
</body>
</html>
