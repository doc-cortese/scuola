<!DOCTYPE html>
<html lang="it">
<head>
  <script>
    // Se non esiste la variabile di sessione, rimanda alla home
    if (sessionStorage.getItem("isLoggedIn") !== "true") {
        alert("Accesso negato. Effettua prima il login sulla home page.");
        window.location.href = "index.html";
    }
  </script>
  <meta charset="UTF-8" />
  <title>Editor Python - Prof. Antonio Adinolfi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script>
    window.require = { paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' } };
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.js"></script>
  

  <style>
    :root {
      --primary-color: #004080;
      --secondary-color: #28a745;
      --danger-color: #dc3545;
      --bg-color: #f8f9fa;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      background-color: var(--bg-color);
      /* Protezione: impedisce la selezione del testo nell'interfaccia */
      user-select: none;
      -webkit-user-select: none;
    }

    /* Layout principale: Colonna su mobile, Riga su desktop */
    #main-layout { 
        display: flex; 
        flex-direction: column; /* Gli elementi si impilano verticalmente [cite: 27] */
        height: 100vh; 
        overflow: hidden; 
    }
    
    /* Regole comuni per le due sezioni */
    #traccia, #editor-section {
        display: flex;
        flex-direction: column;
        padding: 15px;
        background: white;
        min-height: 0;
        width: 100%; /* Su mobile occupano tutta la larghezza [cite: 60] */
    }
    
    /* Su mobile, diamo un'altezza specifica per vedere entrambi */
    #traccia { height: 40vh; border-bottom: 2px solid #ddd; }
    #editor-section { height: 60vh; }
    
    /* Media Query per Desktop (schermi pi√π larghi di 768px) */
    @media (min-width: 768px) {
        #main-layout { flex-direction: row; } /* Affiancati [cite: 36] */
        #traccia { 
            width: 45%; 
            height: 100vh; 
            border-right: 2px solid #ddd; 
            border-bottom: none;
        }
        #editor-section { 
            width: 55%; 
            height: 100vh; 
        }
    }

   #viewerContainer {
        flex-grow: 1; [cite: 48]
        border: 1px solid #ccc; [cite: 49]
        border-radius: 8px; [cite: 50]
        /* Fondamentale per lo scorrimento */
        overflow: auto !important; 
        background-color: #e0e0e0; [cite: 52]
        position: relative; [cite: 56]
        display: block; /* Cambia da flex a block per favorire lo scroll */
    }

    .traccia-img {
        transition: width 0.2s ease-in-out; [cite: 59]
        /* Rimuovi height: auto se presente e usa questa configurazione */
        max-width: none; 
        display: block; [cite: 62]
    }

    
   .controls { 
      margin-bottom: 12px; 
      display: flex; 
      gap: 8px; 
      align-items: center; 
      flex-wrap: wrap; /* Fondamentale: i bottoni scendono se non c'√® posto  */
    }

    input[type="text"] { 
        flex: 1; 
        min-width: 150px; /* Impedisce che l'input diventi troppo piccolo [cite: 64] */
        padding: 8px; 
    }

    button {
      padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;
      font-weight: 600; transition: all 0.2s;
    }
    button:hover { opacity: 0.9; }

    .btn-run { background-color: var(--primary-color); color: white; }
    .btn-drive { background-color: var(--secondary-color); color: white; }
    .btn-exit { background-color: var(--danger-color); color: white; }
    .btn-zoom-ui { background-color: #f0f0f0; border: 1px solid #ccc; font-size: 18px; width: 40px; }

    /* Stili per la nuova Toolbar dello Zoom Codice */
    .zoom-toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f1f5f9;
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
    }
    .btn-z {
      background-color: var(--primary-color);
      color: white;
      padding: 4px 12px;
      font-size: 14px;
    }

    #monaco-container {
      flex-grow: 1; /* Spinge l'editor a occupare tutto lo spazio disponibile [cite: 93] */
      border: 1px solid #ccc;
      border-radius: 0 0 8px 8px;
      overflow: hidden;
      background: #1e1e1e; /* Colore scuro di sfondo per evitare il flash bianco */
    }

     #output {
      background: #0d0d0d !important; 
      color: #00ff41 !important; 
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
      height: 150px; 
      overflow-y: auto;
      font-family: 'Consolas', monospace;
      font-size: 13px;
      border-left: 5px solid var(--primary-color);
      box-shadow: inset 0 0 10px rgba(0,0,0,1);
    }
    #timerDisplay { margin-left: auto; color: var(--danger-color); font-weight: bold; }

    @keyframes rotateHourglass {
      0% { transform: rotate(0deg); }
      45% { transform: rotate(180deg); }
      50% { transform: rotate(180deg); }
      95% { transform: rotate(360deg); }
      100% { transform: rotate(360deg); }
    }

    .clessidra-icon {
        display: inline-block;
        font-size: 18px;
        animation: rotateHourglass 3s infinite ease-in-out;
    }
    /* Animazione per il lampeggio */
    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.2; }
      100% { opacity: 1; }
    }
    
    /* Classe che attiva il lampeggio e colora la clessidra di rosso */
    .urgent-blink {
      animation: rotateHourglass 3s infinite ease-in-out, blink 0.8s infinite !important;
      color: var(--danger-color) !important;
    }
  </style>
  
</head>

<body oncontextmenu="return false;" oncopy="return false;" oncut="return false;" onpaste="return false;">
<div id="schermata-manutenzione" style="position:fixed; top:0; left:0; width:100%; height:100%; background-color:#ffffff; z-index:999999; display:flex; flex-direction:column; align-items:center; justify-content:center; font-family:sans-serif;">
    <img src="./immagini/logo_liceo.png" width="120" style="margin-bottom:20px;">
    <h2 style="color:#0056b3;">Sito in Manutenzione</h2>
    <p>Accesso riservato al Prof. Adinolfi</p>
    <div style="margin-top: 20px;">
        <input type="password" id="pass-docente" placeholder="Password" style="padding:10px; border:1px solid #ccc; border-radius:5px;">
        <button onclick="controllaAccesso()" style="padding:10px 20px; background-color:#0056b3; color:white; border:none; border-radius:5px; cursor:pointer;">Entra</button>
    </div>
    <script src="sicurezza.js"></script>
</div>
<div id="main-layout">
  <div id="traccia">
    <div class="controls">
      <select id="tracciaSelect" onchange="updateTraccia(this.value)"></select>
      <div id="imgZoomControls" style="display:none;">
        <button class="btn-zoom-ui" onclick="zoomImage(1.2)">+</button>
        <button class="btn-zoom-ui" onclick="zoomImage(0.8)">-</button>
      </div>
    </div>
    <div id="viewerContainer">
      <iframe id="pdfFrame" src="" style="width:100%; height:100%; border:none;"></iframe>
    </div>
  </div>

  <div id="editor-section">
    <div class="controls">
      <input type="text" id="nomeStudente" placeholder="Nome e Cognome Studente">
      <div style="display: inline-flex; flex-direction: column; align-items: flex-end; margin-left: auto; margin-right: 15px;">
        <div style="font-size: 11px; color: #666;"><span class="clessidra-icon">‚åõ</span>
          <span id="timerDisplay" style="display: none;">--:--</span> 
        </div>
        <div style="font-weight: bold; color: var(--primary-color);">Fine Prova: <span id="maxTimerDisplay">--:--</span></div>
      </div>
      <button class="btn-exit" onclick="tornaAllaPaginaPrincipale()">Esci</button>
    </div>

    <div class="zoom-toolbar">
        <span style="font-size: 12px; font-weight: bold; color: var(--primary-color);">ZOOM CODICE:</span>
        <button class="btn-z" onclick="changeEditorZoom(2)">+</button>
        <button class="btn-z" onclick="changeEditorZoom(-2)">-</button>
        <button class="btn-z" onclick="resetEditorZoom()" style="background:#64748b;">Reset</button>
        <button class="btn-z" id="focusBtn" onclick="toggleFocusMode()" style="background: #8b5cf6; margin-left: 5px;">Solo Editor</button>
    </div>
    <div id="monaco-container"></div>

    <div class="controls" style="margin-top: 10px;">
      <button class="btn-drive" onclick="inviaConsegnaDrive()" style="padding: 12px 24px; font-size: 16px;">‚òÅÔ∏è INVIA CONSEGNA AL PROF</button>
      <!--<button class="btn-z" onclick="scaricaFileLocale()" style="background:#64748b; padding: 12px 24px;">üíæ Salva copia sul PC (.py)</button>-->
      <button id="eseguiBtn" class="btn-run" onclick="apriPopupTest()" style="background-color: #f9ab00; color: black; padding: 12px 24px;">üöÄ TESTA CODICE (Popup)</button>
    </div>

    
    <div id="output-info" style="background: #f1f5f9; color: #334155; padding: 15px; border-radius: 8px; margin-top: 10px; border-left: 5px solid var(--primary-color);">
      <strong>PRONTO PER LA CONSEGNA:</strong><br>
      Scrivi il tuo codice sopra. Quando hai finito, assicurati di aver inserito Nome e Cognome e premi "Invia al Drive".
    </div>
  </div>
</div>

<iframe name="gasTarget" id="gasTarget" style="display:none;"></iframe>

<script>
  // CONFIGURAZIONE CARTELLE PER CLASSE
  

  let editor, pyodide, timeLeft = 300;
  let maxTimeLeft = 2700; // Valore di default (45 min)
  let currentImgWidth = 100;
  let currentFontSize = 14;
  let warningSent = false;
  const startTime = new Date();

  function aggiornaDisplayTimer() {
    const m1 = Math.floor(timeLeft / 60);
    const s1 = timeLeft % 60;
    
    const timerDisplay = document.getElementById('timerDisplay');
    const clessidra = document.querySelector('.clessidra-icon'); // Seleziona l'icona della clessidra
    
    if (timerDisplay) {
        timerDisplay.textContent = ""; 
    }

    // GESTIONE LAMPEGGIO CLESSIDRA (Inattivit√† < 60 secondi)
    if (clessidra) {
        if (timeLeft <= 60) {
            clessidra.classList.add('urgent-blink');
        } else {
            clessidra.classList.remove('urgent-blink');
        }
    }

    const m2 = Math.floor(maxTimeLeft / 60);
    const s2 = maxTimeLeft % 60;
    document.getElementById('maxTimerDisplay').textContent = `${m2}:${s2.toString().padStart(2, '0')}`;
  }
  // === FUNZIONI ZOOM EDITOR ===
  function changeEditorZoom(delta) {
    currentFontSize += delta;
    if (currentFontSize < 8) currentFontSize = 8;
    if (currentFontSize > 40) currentFontSize = 40;
    if (editor) {
      editor.updateOptions({ fontSize: currentFontSize });
    }
  }

  function resetEditorZoom() {
    currentFontSize = 14;
    if (editor) {
      editor.updateOptions({ fontSize: 14 });
    }
  }

  function toggleFocusMode() {
    const traccia = document.getElementById('traccia');
    const editorSection = document.getElementById('editor-section');
    const focusBtn = document.getElementById('focusBtn');

    if (traccia.style.display !== 'none') {
        // Attiva Modalit√† Focus
        traccia.style.display = 'none';
        editorSection.style.width = '100%';
        editorSection.style.height = '100vh';
        focusBtn.textContent = 'Mostra Traccia';
        focusBtn.style.background = '#64748b';
    } else {
        // Disattiva Modalit√† Focus (Ripristina layout)
        traccia.style.display = 'flex';
        focusBtn.textContent = 'Solo Editor';
        focusBtn.style.background = '#8b5cf6';
        
        // Applica i ripristini in base alla larghezza dello schermo
        if (window.innerWidth >= 768) {
            editorSection.style.width = '55%';
            editorSection.style.height = '100vh';
        } else {
            editorSection.style.width = '100%';
            editorSection.style.height = '60vh';
        }
    }
  
    // Forza Monaco a ricalcolare le dimensioni dopo il cambio layout
    if (editor) {
        editor.layout();
    }
  }

  // === BLOCCO TASTIERA ANTI-COPIA ===
  document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && ['c','v','x','s','u'].includes(e.key.toLowerCase())) {
        e.preventDefault();
        alert("Attenzione: Funzioni di copia/incolla disabilitate.");
    }
  });

  
 function updateTraccia(filePath) {
    const container = document.getElementById('viewerContainer');
    const zoomControls = document.getElementById('imgZoomControls');
    // Verifica se il file √® un'immagine [cite: 187]
    const isImage = /\.(jpg|jpeg|png)$/i.test(filePath); 

    if (isImage) {
        // Correzione: usa i backtick ` e assegna correttamente l'HTML [cite: 189]
        container.innerHTML = `<img src="${filePath}" class="traccia-img" style="width:100%; height:auto; display:block;">`;
        zoomControls.style.display = 'block'; // Mostra i tasti + e - [cite: 189]
        currentImgWidth = 100; // Reset larghezza [cite: 190]
    } else {
        // Se √® un PDF [cite: 191]
        container.innerHTML = `<iframe id="pdfFrame" src="${filePath}" style="width:100%; height:100%; border:none;"></iframe>`;
        zoomControls.style.display = 'none'; // Nascondi zoom per PDF [cite: 194]
    }
    resetActivityTimer(); // [cite: 195]
  }

  function zoomImage(step) {
    const img = document.querySelector('.traccia-img');
    const container = document.getElementById('viewerContainer');
    
    if (img && container) {
        // 1. Calcola la nuova larghezza [cite: 180]
        currentImgWidth = currentImgWidth * step;
        
        // 2. Applica la larghezza all'immagine [cite: 182]
        img.style.width = currentImgWidth + '%';
        
        // 3. Rendi l'immagine "libera" di espandersi per attivare lo scroll
        img.style.maxWidth = 'none'; 
        
        // 4. Assicura che il contenitore permetta lo scorrimento [cite: 51]
        container.style.overflow = 'auto';
        container.style.display = 'block'; 
    }
  }

  window.inviaConsegnaDrive = function() {
    const nome = document.getElementById("nomeStudente").value.trim();
    if (!nome) return alert("Inserisci Nome e Cognome!");

    const endTime = new Date();
    const diffMs = endTime - startTime;
    const diffMins = Math.floor(diffMs / 60000);
    const diffSecs = Math.floor((diffMs % 60000) / 1000);
    const tempoTotale = `${diffMins} minuti e ${diffSecs} secondi`;

    const codice = editor.getValue();
    // Cerca l'elemento 'output' (se esiste ancora) oppure usa un testo di default
    const outputElement = document.getElementById("output");
    const outputText = outputElement ? outputElement.textContent : "Output non disponibile (compilatore disattivato)";
    const urlParams = new URLSearchParams(window.location.search);
    const classe = urlParams.get("classe") || "ND";

    const rtfContent = `{\\rtf1\\ansi Studente: ${nome}\\par Classe: ${classe}\\par\\par INIZIO PROVA: ${startTime.toLocaleString()}\\par FINE PROVA: ${endTime.toLocaleString()}\\par TEMPO TOTALE: ${tempoTotale}\\par\\par CODICE:\\par ${codice.replace(/\n/g, '\\par ')}\\par\\par OUTPUT:\\par ${outputText.replace(/\n/g, '\\par ')} }`;

    const blob = new Blob([rtfContent], { type: 'application/rtf' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `Consegna_${nome.replace(/\s+/g, '_')}.rtf`;
    a.click();

    const GAS_URL = "https://script.google.com/macros/s/AKfycbyXYR1fJ2yYKKbgd_cIdNUTbIG5fZH3piPQ75Bw2TC-YkMcUaM7bOvzUQWNNGGmjcdg/exec";
    const form = document.createElement('form');
    form.method = 'POST'; form.action = GAS_URL; form.target = 'gasTarget';
    
    const add = (n, v) => {
      const i = document.createElement('input'); i.type = 'hidden'; i.name = n; i.value = v;
      form.appendChild(i);
    };

    add('nomeStudente', nome);
    add('classe', classe);
    add('dataOra', endTime.toLocaleString());
    add('rtfContent', rtfContent);
    add('pyContent', codice);
    
    document.body.appendChild(form);
    form.submit();
    alert("‚úÖ Consegna inviata al Drive!");
    maxTimeLeft=2700;
  };

  function resetActivityTimer() { timeLeft = 300; }

  function tornaAllaPaginaPrincipale() { 
    const urlParams = new URLSearchParams(window.location.search);
    const cl = urlParams.get('classe') || 'default';
    const classKey = cl.charAt(0).toUpperCase() + cl.slice(1);
    
    // RIMUOVI queste righe se vuoi che la traccia rimanga la stessa al rientro:
    // localStorage.removeItem(`tracciaAssegnata_${classKey}`); 
    
    // Mantieni invece la pulizia dei dati sensibili se necessario
    localStorage.removeItem(`codiceSalvato_${classKey}`);
    localStorage.removeItem("nomeStudente");
    
    window.location.href = '../index.html'; 
}

  require(['vs/editor/editor.main'], function () {
    editor = monaco.editor.create(document.getElementById('monaco-container'), {
      value: "# Scrivi qui il tuo codice Python\n",
      language: 'python',
      theme: 'vs-dark',
      automaticLayout: true,
      fontSize: 14,
      contextmenu: false,
      minimap: { enabled: false }
    });
    editor.onDidPaste((e) => { e.stopImmediatePropagation(); alert('üö´ Incolla disabilitato.'); });
    editor.onDidChangeModelContent(() => { resetActivityTimer(); });

    const urlParams = new URLSearchParams(window.location.search);
    const cl = urlParams.get('classe') || 'default';
    const classKey = cl.charAt(0).toUpperCase() + cl.slice(1);
    const lastCode = localStorage.getItem(`codiceSalvato_${classKey}`);
    if (lastCode) editor.setValue(lastCode);
  });

  async function runCode() {
    const out = document.getElementById('output');
    const btn = document.getElementById('eseguiBtn');
    
    out.textContent = "‚è≥ Esecuzione in corso...";
    
    try {
        // Verifica se pyodide √® stato caricato correttamente
        if (typeof loadPyodide === 'undefined') {
            out.textContent = "Errore: Libreria Pyodide non trovata. Controlla la connessione internet.";
            return;
        }

        if (!pyodide) {
            pyodide = await loadPyodide();
        }

        // Setup per catturare il print() di Python
        await pyodide.runPythonAsync(`
import sys
import io
sys.stdout = io.StringIO()
        `);

        // Prendi il codice dall'editor Monaco
        const code = editor.getValue();
        
        // Esegui il codice
        await pyodide.runPythonAsync(code);

        // Estrai l'output catturato
        const stdout = pyodide.runPython("sys.stdout.getvalue()");
        
        out.textContent = stdout || "‚úÖ Codice eseguito (nessun output da visualizzare).";

    } catch (err) {
        // Mostra l'errore Python nella console verde
        out.textContent = "‚ùå ERRORE PYTHON:\n" + err;
    }
  }
  function scaricaFileLocale() {
    const codice = editor.getValue();
    const nome = document.getElementById("nomeStudente").value.trim() || "studente_senza_nome";
    const blob = new Blob([codice], { type: 'text/plain' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `Esercizio_${nome.replace(/\s+/g, '_')}.py`;
    link.click();
  }
 document.addEventListener("DOMContentLoaded", async () => {
    try {
        // 1. CARICAMENTO DINAMICO DELLA CONFIGURAZIONE
        const response = await fetch('config.json');
        const config = await response.json();
        
        const urlParams = new URLSearchParams(window.location.search);
        const cl = urlParams.get('classe') || 'default';
        const classKey = cl.charAt(0).toUpperCase() + cl.slice(1);
        
        // 2. RECUPERO ESERCIZI PER LA CLASSE SELEZIONATA
        const exercises = config.classi[classKey] || config.classi['default'] || [];
        const select = document.getElementById('tracciaSelect');

        // 3. ASSEGNAZIONE CASUALE PERSISTENTE
        const tracciaKey = `tracciaAssegnata_${classKey}`;
        let assignedIndex = localStorage.getItem(tracciaKey);
        
        if (assignedIndex === null || assignedIndex >= exercises.length) {
            assignedIndex = Math.floor(Math.random() * exercises.length);
            localStorage.setItem(tracciaKey, assignedIndex);
        } else {
            assignedIndex = parseInt(assignedIndex);
        }

        // 4. POPOLAMENTO MENU E VISUALIZZAZIONE TRACCIA
        exercises.forEach((ex, index) => {
            const opt = document.createElement('option');
            opt.value = `tracce/${ex.file}`; 
            opt.textContent = ex.title;
            if (index === assignedIndex) opt.selected = true;
            select.appendChild(opt);
        });
        
        select.disabled = true; // Impedisce allo studente di cambiare traccia
        if (exercises[assignedIndex]) {
            updateTraccia(`tracce/${exercises[assignedIndex].file}`);
        }

        // 5. GESTIONE TIMER PERSISTENTE
        const timerKey = `timer_${classKey}`;
        const savedTime = localStorage.getItem(timerKey);
        maxTimeLeft = savedTime !== null ? parseInt(savedTime) : config.impostazioni.timerDefault;

        aggiornaDisplayTimer(); 

        // 6. AVVIO CICLI (Timer e Backup)
        setInterval(() => {
            if (maxTimeLeft <= 0) {
                alert("Tempo scaduto!");
                tornaAllaPaginaPrincipale();
                return;
            }
            maxTimeLeft--;
            localStorage.setItem(timerKey, maxTimeLeft);
            aggiornaDisplayTimer();
        }, 1000);

        setInterval(() => {
            if (editor) {
                localStorage.setItem(`codiceSalvato_${classKey}`, editor.getValue());
                console.log("Backup dinamico eseguito");
            }
        }, config.impostazioni.intervalloBackup);

    } catch (err) {
        console.error("Errore nel caricamento dinamico:", err);
        alert("Errore critico nel caricamento della configurazione classi.");
    }
});
  function apriPopupTest() {
      const codice = editor.getValue();
      
      // Tentativo di copia automatica negli appunti per agevolare lo studente
      navigator.clipboard.writeText(codice).then(() => {
          alert("Codice copiato negli appunti!\n\nSi aprir√† una nuova finestra: incolla il codice (Ctrl+V) e premi 'Run'.");
      }).catch(err => {
          alert("Si aprir√† il tester. Ricorda di copiare il tuo codice manualmente.");
      });
  
      // Opzione A: Programiz (Molto leggero e stabile)
      const urlTester = "https://www.programiz.com/python-programming/online-compiler/";
      
      // Apre il popup con dimensioni specifiche
      const width = 1000;
      const height = 700;
      const left = (window.screen.width / 2) - (width / 2);
      const top = (window.screen.height / 2) - (height / 2);
      
      window.open(urlTester, "TesterPython", `width=${width},height=${height},top=${top},left=${left},resizable=yes,scrollbars=yes`);
  }
</script>
</body>
</html>
